##  5장. 안정 해시 설계

스케일 아웃을 올바르게 하기위해서는 균등한 분포가 중요하다.

“안정 해시”는 균등한 분포를 위해 사용하는 보편적인 기술

안정 해시 기술 왜 필요한지 알기위해, “해시 키 재배치 문제”를 살펴보자


- 해시 키 재배치 문제

  N개의 캐시 서버가 있다고 하자.

  캐시 서버들에 부하를 균등히 나누기위해서, 모듈러 연산을 사용하면된다.

  `서버 인덱스 = 해시키 % N` 하면 된다.

  너~ 무 좋다.

  그런데, 여기서 간과한 몇 가지 사실이 있다.

  1. 서버 풀 크기가 고정되어있다.
  2. 해시 키 분포가 균등하다

  서버 풀이 변동되었을 때를 자세히 살펴보면

  서버 4개 → 서버 3개 인 상황을 살펴보면 ,

  기존에 접근하던 서버 인덱스가 뒤틀리게되어, 키-서버 매핑이 광범위하게 뒤틀려 캐시 적중률이 급락.
  즉, 대규모 캐시 miss 가 발생하게 된다.

  → 이런 문제는 “안정 해시” 로 해결 할 수 있다.

### 안정 해시

> k : key 의 갯수, n : 슬롯 갯수
> 
> 대부분 해시 테이블은 슬롯 수가 변경되면 키를 재배치한다.
> 
> 안정 해시는 해시 테이블 크기가 조정될 때, 평균적으로 k/n 개의 키만 재배치하는 해시기술이다.

  - 동작원리 (개략적)
    
      해시 함수로 SHA-1 를 사용한다 했을 때, 그 범위를 `x0` ~ `xn` 이라하고하자. 
    
      해시 공간을 양쪽으로 구부려 접으면 해시링을 만들 수 있다.(추상적인 개념) 
    
      C에서 기본형 타입의 오버플로 그림 을 떠올리자. 
    
      매핑할 타겟이 해시링 위에 있다고 하고,  

      해시키 역시 해시링 위에 있다고해보자, 
    
      해시키가 시계방향으로 탐색하며, 가장 처음으로 만나는 타겟이 매핑된다.
    
      이렇게하면, 매핑할 타겟이 추가/삭제 되더라도 일부의 타겟만 재배치하면된다.
  
  
  - 기본 구현법
    1. 타겟과 키를 균등 분포 해시 함수를 사용해 링에 배치한다.
    2. 키의 위치와 링을 시계방향으로 탐색하다 만나는 최초의 타겟이 맵핑된다.
       안정 해시 알고리즘은 MIT 에서 처음 제안되었고, 흐름은 위와 같다.
       하지만!, 이 접근법에는 문제가 있다.
    

  - 안정 해시 기본 구현의 문제점

    해시 함수가 키를 균등하게 링 위에 뿌려주더라도,
    
    추가/삭제 가 되면 해시공간이 균일한 공간 유지가 어렵다.
    
    추가/삭제 가 되면 키가 균일하게 분포되지 않는다.
    
    안정 해시 기본 구현의 문제점을 해결하기위해서, 가상 노드, 레플리카 기법을 사용한다.  


  - 가상 노드, 레플리카 기법
    
    가상 노드란?

        → 실제 노드 또는 서버를 가리키는 노드
        → 하나의 서버는 링 위에 여러개의 가상 노드를 가질 수 있다.
        → 이렇게 함으로써, 각 서버는 여러 개의 해시 공간 을 관리해야한다.
    
    이제 기본 구현법 + 가상 노드 를 해보자

        → 해시키가 시계방향으로 탐색하며, 가장 처음으로 만나는 타겟(가상 노드)가 매핑된다.
        → 가상 노드 갯수를 늘리면 늘릴 수 록, 키의 분포는 점점 균등해진다.
        → 표준 편차가 작아져, 고르게 분포되기에..
        → 그러나, 가상노드 갯수를 무작정 늘리면, 가상 노드 데이터를 저장할 공간은 더 많이 필요해지게 되니, tradeoff (타협적 결정)이 필요하다.

### 안정 해시 이점 정리

- 서버 (추가/삭제) 될 때 재배치 되는 키의 수를 최소화 할 수 있다.
- 데이터가 균등히 분포되게하여 scale out 의 확장성을 달성 할 수 있다.
- 핫 스팟 키 문제를 줄인다.

  > 특정 샤드에 대한 접근이 지나치게 빈번하면 서버 과부하가 문제가 생기는데,
  > 
  > 안정해시를 사용하면 데이터를 보다 균등히 분배할 수 있다.

안정해시는 꽤 널리쓰이는 기술임

    다이나모 DB : 파티셔닝 관련
    카산드라 : 클러스터에서 데이터 파티셔닝
    디스코드 : 채팅 어플리케이션
    아카마이 : CDN
